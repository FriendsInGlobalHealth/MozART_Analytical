---Created by: Marcela Torres and Randy Yee
---Used the Retention_12m table and added VL and CD4 data from MozART
---Restricting to those patients who initiated treatment in 2017
---Results need to be QCed

IF OBJECT_ID('[Sandbox].[dbo].[Retention_12m_Bulletin]', N'U') IS NOT NULL
	DROP TABLE [Sandbox].[dbo].[Retention_12m_Bulletin]
GO
	
	SELECT *,lastVL, resultVL, firstcd, resultcd FROM dbo.Retention_12m person

	---joining latest VL results
		LEFT JOIN
	(SELECT * FROM(
	SELECT ROW_NUMBER() OVER (PARTITION BY nts.nid, nts.AccessFilePath ORDER BY nts.datavl desc) as rownum, nts.nid, nts.AccessFilePath
	, nts.datavl as lastVL, nts.resultado as resultVL
	FROM 
		(
		SELECT ts.nid, ts.AccessFilePath, cast(dataresultado as date) as datavl, codexame, resultado
		FROM MozART_q3_2019.dbo.t_resultadoslaboratorio  ts 
		LEFT JOIN
		(SELECT nid, AccessFilePath, cast(datainiciotarv as date) Iniciotarv
		FROM MozART_q3_2019.dbo.t_paciente) tpo1
		ON ts.nid = tpo1.nid AND ts.AccessFilePath = tpo1.AccessFilePath
		WHERE cast(dataresultado AS date) <= dateadd(mm,12,tpo1.Iniciotarv)  AND codexame='Carga Viral'
		) nts
	) s
	WHERE s.rownum = '1') ss1
	ON person.nid = ss1.nid
	
	---joining latest CD4 results
		LEFT JOIN
	(SELECT * FROM(
	SELECT ROW_NUMBER() OVER (PARTITION BY nts.nid, nts.AccessFilePath ORDER BY nts.datacd asc) as rownum, nts.nid, nts.AccessFilePath
	, nts.datacd as firstcd, nts.resultado as resultcd
	FROM 
		(
		SELECT ts.nid, ts.AccessFilePath, cast(dataresultado as date) as datacd, codexame, resultado
		FROM MozART_q3_2019.dbo.t_resultadoslaboratorio  ts
		LEFT JOIN
		(SELECT nid, AccessFilePath, cast(datainiciotarv as date) Iniciotarv
		FROM MozART_q3_2019.dbo.t_paciente) tpo1
		ON ts.nid = tpo1.nid AND ts.AccessFilePath = tpo1.AccessFilePath
		WHERE codexame='CD4'
		) nts
	) s
	WHERE s.rownum = '1') ss2
	ON person.nid = ss2.nid
	WHERE Cohort_Year = '2017'

	
